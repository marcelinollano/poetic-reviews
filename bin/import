#!/usr/bin/env ruby

require 'rubygems'
require 'bundler'
Bundler.require
Dotenv.load

Dir["./lib/*.rb"].each { |file| require file }

name = 'Puerta del Sol'
url  = 'https://www.google.com/maps/place/Puerta+del+Sol/@40.4169514,-3.7057225,17z/data=!3m1!4b1!4m5!3m4!1s0xd42287e19e23f5f:0xcec2a0e4d9bed6fb!8m2!3d40.4169473!4d-3.7035285'
data = './data/puerta-del-sol/helpful.html'

puts "=====> Import #{name}"

thing  = Thing.save({
  :name => name,
  :url => url
})

reviews = GoogleMaps.scrap(data)

begin
  reviews.each do |review|
    puts "-----> Review by #{review[:author]}"
    review = Review.save({
      :thing_id => thing.id,
      :text => review[:text],
      :author => review[:author],
      :published_at => review[:published_at]
    })
  end
rescue Google::Cloud::ResourceExhaustedError
  puts "-----> Waiting to retry..."
  sleep(0.5)
  retry
end

puts "-----> #{reviews.size} were imported"
